"use strict";(globalThis.webpackChunkrock_docs=globalThis.webpackChunkrock_docs||[]).push([[1345],{43698(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>s,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"References/Python SDK References/runtime-env","title":"RuntimeEnv","description":"The RuntimeEnv module is used to manage language runtime environments in the sandbox (currently providing Python / Node.js).","source":"@site/versioned_docs/version-1.2.x/References/Python SDK References/runtime-env.md","sourceDirName":"References/Python SDK References","slug":"/References/Python SDK References/runtime-env","permalink":"/ROCK/docs/References/Python SDK References/runtime-env","draft":false,"unlisted":false,"editUrl":"https://github.com/alibaba/ROCK/tree/master/docs/versioned_docs/version-1.2.x/References/Python SDK References/runtime-env.md","tags":[],"version":"1.2.x","lastUpdatedAt":1771903476000,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Rock Agent (Experimental)","permalink":"/ROCK/docs/References/Python SDK References/rock-agent"},"next":{"title":"Handling Large Files and Long Command Outputs","permalink":"/ROCK/docs/References/Python SDK References/sandbox"}}');var r=t(74848),d=t(28453);const s={},o="RuntimeEnv",l={},c=[{value:"Quick Start (Example)",id:"quick-start-example",level:2},{value:"RuntimeEnv.create",id:"runtimeenvcreate",level:2},{value:"wrapped_cmd",id:"wrapped_cmd",level:2},{value:"run",id:"run",level:2},{value:"PythonRuntimeEnvConfig",id:"pythonruntimeenvconfig",level:2},{value:"NodeRuntimeEnvConfig",id:"noderuntimeenvconfig",level:2},{value:"Constraints for Custom RuntimeEnv Implementations",id:"constraints-for-custom-runtimeenv-implementations",level:2},{value:"Simplified NodeRuntimeEnv Implementation Example",id:"simplified-noderuntimeenv-implementation-example",level:2},{value:"Speeding Up Base Runtime Installation",id:"speeding-up-base-runtime-installation",level:2}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"runtimeenv",children:"RuntimeEnv"})}),"\n",(0,r.jsx)(n.p,{children:"The RuntimeEnv module is used to manage language runtime environments in the sandbox (currently providing Python / Node.js)."}),"\n",(0,r.jsx)(n.h2,{id:"quick-start-example",children:"Quick Start (Example)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'from rock.sdk.sandbox import Sandbox\nfrom rock.sdk.sandbox.config import SandboxConfig\nfrom rock.sdk.sandbox.runtime_env import RuntimeEnv, NodeRuntimeEnvConfig\n\nsandbox_config = SandboxConfig()\nsandbox = Sandbox()\nawait sandbox.start()\n\nnode_runtime_env_config = NodeRuntimeEnvConfig(version="default")\nenv = await RuntimeEnv.create(sandbox, node_runtime_env_config)\n\nawait env.run("node --version")\n'})}),"\n",(0,r.jsx)(n.h2,{id:"runtimeenvcreate",children:"RuntimeEnv.create"}),"\n",(0,r.jsxs)(n.p,{children:["An async factory method that creates and initializes a RuntimeEnv instance based on the configuration, and automatically registers it to ",(0,r.jsx)(n.code,{children:"sandbox.runtime_envs"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'from rock.sdk.sandbox.runtime_env import RuntimeEnv, NodeRuntimeEnvConfig\n\nenv = await RuntimeEnv.create(\n    sandbox,\n    NodeRuntimeEnvConfig(version="22.18.0"),\n)\n\n# Auto-registered; accessible via sandbox.runtime_envs[env.runtime_env_id]\nprint(env.runtime_env_id in sandbox.runtime_envs)  # True\n'})}),"\n",(0,r.jsx)(n.h2,{id:"wrapped_cmd",children:"wrapped_cmd"}),"\n",(0,r.jsxs)(n.p,{children:["Wraps a command by adding ",(0,r.jsx)(n.code,{children:"bin_dir"})," to PATH to ensure executables from the runtime environment are used with priority."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"wrapped = env.wrapped_cmd(\"node script.js\")\n# Returns: bash -c 'export PATH=/tmp/rock-runtime-envs/node/22.18.0/xxx/runtime-env/bin:$PATH && node script.js'\n"})}),"\n",(0,r.jsx)(n.h2,{id:"run",children:"run"}),"\n",(0,r.jsxs)(n.p,{children:["Executes a command within the runtime environment. Internally implemented based on ",(0,r.jsx)(n.code,{children:"wrapped_cmd"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'await env.run("node script.js")\nawait env.run("npm install express")\n'})}),"\n",(0,r.jsx)(n.h2,{id:"pythonruntimeenvconfig",children:"PythonRuntimeEnvConfig"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Field"}),(0,r.jsx)(n.th,{children:"Type"}),(0,r.jsx)(n.th,{children:"Default"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"type"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:'Literal["python"]'})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:'"python"'})}),(0,r.jsx)(n.td,{children:"Type identifier"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"version"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:'"3.11" | "3.12" | "default"'})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:'"default"'})}),(0,r.jsx)(n.td,{children:"Python version; default is 3.11"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"pip"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"list[str] | str | None"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"None"})}),(0,r.jsx)(n.td,{children:"List of pip packages or a requirements.txt path"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"pip_index_url"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"str | None"})}),(0,r.jsx)(n.td,{children:"Environment variable"}),(0,r.jsx)(n.td,{children:"pip index mirror"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"extra_symlink_dir"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"str | None"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"None"})}),(0,r.jsx)(n.td,{children:"Target directory for executable symlinks"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"extra_symlink_executables"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"list[str]"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:'["python", "python3", "pip", "pip3"]'})}),(0,r.jsx)(n.td,{children:"List of executables to symlink"})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"noderuntimeenvconfig",children:"NodeRuntimeEnvConfig"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Field"}),(0,r.jsx)(n.th,{children:"Type"}),(0,r.jsx)(n.th,{children:"Default"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"type"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:'Literal["node"]'})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:'"node"'})}),(0,r.jsx)(n.td,{children:"Type identifier"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"version"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:'"22.18.0" | "default"'})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:'"default"'})}),(0,r.jsx)(n.td,{children:"Node version; default is 22.18.0"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"npm_registry"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"str | None"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"None"})}),(0,r.jsx)(n.td,{children:"npm registry mirror"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"extra_symlink_dir"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"str | None"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"None"})}),(0,r.jsx)(n.td,{children:"Target directory for executable symlinks"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"extra_symlink_executables"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"list[str]"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:'["node", "npm", "npx"]'})}),(0,r.jsx)(n.td,{children:"List of executables to symlink"})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"constraints-for-custom-runtimeenv-implementations",children:"Constraints for Custom RuntimeEnv Implementations"}),"\n",(0,r.jsx)(n.p,{children:"A custom RuntimeEnv must follow these rules:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsxs)(n.strong,{children:["Define the ",(0,r.jsx)(n.code,{children:"runtime_env_type"})," class attribute"]}),": used as a type identifier for automatic registration into the RuntimeEnv factory"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsxs)(n.strong,{children:["Override ",(0,r.jsx)(n.code,{children:"_get_install_cmd()"})]}),": return the install command"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"The install command must end with"}),": renaming the directory to ",(0,r.jsx)(n.code,{children:"runtime-env"})]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"simplified-noderuntimeenv-implementation-example",children:"Simplified NodeRuntimeEnv Implementation Example"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'from rock.sdk.sandbox.runtime_env import RuntimeEnv, RuntimeEnvConfig\nfrom typing import Literal\nfrom pydantic import Field\nfrom typing_extensions import override\n\n# Config class: defines the config type so RuntimeEnv.create() can route to the corresponding implementation\nclass NodeRuntimeEnvConfig(RuntimeEnvConfig):\n    type: Literal["node"] = "node"  # Must match runtime_env_type\n\n# RuntimeEnv implementation class: defines how to install and run this runtime environment\nclass NodeRuntimeEnv(RuntimeEnv):\n    runtime_env_type = "node"  # Auto-registered to RuntimeEnv._REGISTRY\n\n    @override\n    def _get_install_cmd(self) -> str:\n        # Download the Node binary tarball and extract it, then rename to runtime-env\n        return (\n            "wget -q -O node.tar.xz https://npmmirror.com/mirrors/node/v22.18.0/node-v22.18.0-linux-x64.tar.xz && "\n            "tar -xf node.tar.xz && "\n            "mv node-v22.18.0-linux-x64 runtime-env"\n        )\n'})}),"\n",(0,r.jsx)(n.h2,{id:"speeding-up-base-runtime-installation",children:"Speeding Up Base Runtime Installation"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"PythonRuntimeEnv"})," downloads Python packages from ",(0,r.jsx)(n.a,{href:"https://github.com/astral-sh/python-build-standalone/releases/",children:"https://github.com/astral-sh/python-build-standalone/releases/"})," by default. If the network is unavailable or slow, you can override the default install command via ",(0,r.jsx)(n.code,{children:"ROCK_RTENV_PYTHON_V31114_INSTALL_CMD"})," or ",(0,r.jsx)(n.code,{children:"ROCK_RTENV_PYTHON_V31212_INSTALL_CMD"})," (e.g., switch to an internal registry or a mirror)."]}),"\n",(0,r.jsx)(n.p,{children:"Default value example:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'"ROCK_RTENV_PYTHON_V31114_INSTALL_CMD": lambda: os.getenv(\n    "ROCK_RTENV_PYTHON_V31114_INSTALL_CMD",\n    "[ -f cpython31114.tar.gz ] && rm cpython31114.tar.gz; [ -d python ] && rm -rf python; "\n    "wget -q -O cpython31114.tar.gz https://github.com/astral-sh/python-build-standalone/releases/download/20251120/cpython-3.11.14+20251120-x86_64-unknown-linux-gnu-install_only.tar.gz "\n    "&& tar -xzf cpython31114.tar.gz && mv python runtime-env",\n),\n'})}),"\n",(0,r.jsx)(n.p,{children:"For example, override it to download from a mirror:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"export ROCK_RTENV_PYTHON_V31114_INSTALL_CMD='[ -f cpython31114.tar.gz ] && rm cpython31114.tar.gz; [ -d python ] && rm -rf python; wget -q -O cpython31114.tar.gz https://mirror.nju.edu.cn/github-release/astral-sh/python-build-standalone/20251209/cpython-3.11.14+20251209-x86_64-unknown-linux-gnu-install_only.tar.gz && tar -xzf cpython31114.tar.gz && mv python runtime-env'\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Make sure the command creates a ",(0,r.jsx)(n.code,{children:"runtime-env"})," directory under the default working directory of ",(0,r.jsx)(n.code,{children:"runtime_env"}),", and that ",(0,r.jsx)(n.code,{children:"${workdir}/runtime-env/bin/"})," contains the expected executables, e.g.:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"${workdir}/runtime-env/bin/python"})}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["The same applies to Node.js: you can override the install command via ",(0,r.jsx)(n.code,{children:"ROCK_RTENV_NODE_V22180_INSTALL_CMD"})," to use a faster download/install method."]})]})}function h(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},28453(e,n,t){t.d(n,{R:()=>s,x:()=>o});var i=t(96540);const r={},d=i.createContext(r);function s(e){const n=i.useContext(d);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),i.createElement(d.Provider,{value:n},e.children)}}}]);