"use strict";(globalThis.webpackChunkrock_docs=globalThis.webpackChunkrock_docs||[]).push([[6002],{3759(e,n,l){l.r(n),l.d(n,{assets:()=>t,contentTitle:()=>o,default:()=>h,frontMatter:()=>c,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"References/Python SDK References/model-service","title":"Model Service (Experimental)","description":"The Model Service provided by ROCK is responsible for handling AI model call communications, serving as a communication bridge between agents and training frameworks (such as Roll) or actual LLM inference services.","source":"@site/versioned_docs/version-1.1.x/References/Python SDK References/model-service.md","sourceDirName":"References/Python SDK References","slug":"/References/Python SDK References/model-service","permalink":"/ROCK/docs/1.1.x/References/Python SDK References/model-service","draft":false,"unlisted":false,"editUrl":"https://github.com/alibaba/ROCK/tree/master/docs/versioned_docs/version-1.1.x/References/Python SDK References/model-service.md","tags":[],"version":"1.1.x","lastUpdatedAt":1772097125000,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"FileSystem","permalink":"/ROCK/docs/1.1.x/References/Python SDK References/file_system"},"next":{"title":"Remote User","permalink":"/ROCK/docs/1.1.x/References/Python SDK References/remote_user"}}');var s=l(74848),r=l(28453);const c={},o="Model Service (Experimental)",t={},d=[{value:"RockAgent Integration",id:"rockagent-integration",level:2},{value:"Architecture Overview (Local Mode)",id:"architecture-overview-local-mode",level:2},{value:"anti_call_llm - Core API",id:"anti_call_llm---core-api",level:2},{value:"CLI Commands",id:"cli-commands",level:2},{value:"start command",id:"start-command",level:3},{value:"watch-agent command",id:"watch-agent-command",level:3},{value:"stop command",id:"stop-command",level:3},{value:"anti-call-llm command",id:"anti-call-llm-command",level:3},{value:"File Communication Protocol",id:"file-communication-protocol",level:2},{value:"Request Format",id:"request-format",level:3},{value:"Response Format",id:"response-format",level:3},{value:"Session End Marker",id:"session-end-marker",level:3},{value:"SDK Usage",id:"sdk-usage",level:2},{value:"ModelServiceConfig",id:"modelserviceconfig",level:3},{value:"ModelService",id:"modelservice",level:3},{value:"API Reference",id:"api-reference",level:2},{value:"install()",id:"install",level:3},{value:"start()",id:"start",level:3},{value:"stop()",id:"stop",level:3},{value:"watch_agent(pid)",id:"watch_agentpid",level:3},{value:"anti_call_llm(index, response_payload, call_timeout, check_interval)",id:"anti_call_llmindex-response_payload-call_timeout-check_interval",level:3},{value:"Configuration Options",id:"configuration-options",level:2},{value:"Service Configuration",id:"service-configuration",level:3},{value:"Log Configuration",id:"log-configuration",level:3},{value:"Polling Configuration",id:"polling-configuration",level:3},{value:"Marker Configuration",id:"marker-configuration",level:3}];function a(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"model-service-experimental",children:"Model Service (Experimental)"})}),"\n",(0,s.jsx)(n.p,{children:"The Model Service provided by ROCK is responsible for handling AI model call communications, serving as a communication bridge between agents and training frameworks (such as Roll) or actual LLM inference services."}),"\n",(0,s.jsx)(n.h2,{id:"rockagent-integration",children:"RockAgent Integration"}),"\n",(0,s.jsxs)(n.p,{children:["ModelService is typically ",(0,s.jsx)(n.strong,{children:"automatically managed by RockAgent"})," - no manual lifecycle management is required. Simply enable it in the configuration:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"from rock.sdk.sandbox.model_service.base import ModelServiceConfig\n\nconfig = ModelServiceConfig(\n    enabled=True,  # Enable ModelService, RockAgent manages its lifecycle\n)\n"})}),"\n",(0,s.jsx)(n.p,{children:"RockAgent will automatically:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Install ModelService (install Python runtime, install model service package)"}),"\n",(0,s.jsx)(n.li,{children:"Start/stop ModelService"}),"\n",(0,s.jsx)(n.li,{children:"Monitor Agent process"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"architecture-overview-local-mode",children:"Architecture Overview (Local Mode)"}),"\n",(0,s.jsxs)(n.p,{children:["In local mode, the model service uses the ",(0,s.jsx)(n.strong,{children:"file system"})," as the communication medium, implementing a request-response mechanism between agents and models."]}),"\n",(0,s.jsx)(n.p,{children:"When an agent needs to call a model, the request is first written to a log file, then processed by the listening component. When the model generates a response, the result is written back to the log file and read by the waiting agent."}),"\n",(0,s.jsx)(n.h2,{id:"anti_call_llm---core-api",children:"anti_call_llm - Core API"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"anti_call_llm()"})," is the ",(0,s.jsx)(n.strong,{children:"most important API in Local mode"}),", used to manually trigger LLM anti-calls for fine-grained control over model calls:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"result = await model_service.anti_call_llm(\n    index=0,                                   # LLM call index\n    response_payload='OpenAI type response',       # Response data (optional)\n    call_timeout=600,                          # Operation timeout (seconds)\n    check_interval=3,                          # Status check interval (seconds)\n)\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Use cases:"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"After Agent captures LLM response, call this method to notify Roll runtime"}),"\n",(0,s.jsx)(n.li,{children:"Supports carrying response data for error handling or retry"}),"\n",(0,s.jsx)(n.li,{children:"Configurable timeout and check interval for different network environments"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"cli-commands",children:"CLI Commands"}),"\n",(0,s.jsxs)(n.p,{children:["To use the model service via CLI, ROCK provides a set of CLI commands that can be accessed via ",(0,s.jsx)(n.code,{children:"rock model-service"})," after installing ROCK in the sandbox:"]}),"\n",(0,s.jsx)(n.h3,{id:"start-command",children:"start command"}),"\n",(0,s.jsx)(n.p,{children:"Start the model service process"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"rock model-service start --type [local|proxy]\n"})}),"\n",(0,s.jsx)(n.p,{children:"Parameters:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"--type"}),": Model service type, optional ",(0,s.jsx)(n.code,{children:"local"})," or ",(0,s.jsx)(n.code,{children:"proxy"}),", defaults to ",(0,s.jsx)(n.code,{children:"local"})]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"watch-agent-command",children:"watch-agent command"}),"\n",(0,s.jsx)(n.p,{children:"Monitor the agent process and send a SESSION_END message when the process exits"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"rock model-service watch-agent --pid <process_id>\n"})}),"\n",(0,s.jsx)(n.p,{children:"Parameters:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"--pid"}),": The ID of the agent process to monitor"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"stop-command",children:"stop command"}),"\n",(0,s.jsx)(n.p,{children:"Stop the model service"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"rock model-service stop\n"})}),"\n",(0,s.jsx)(n.h3,{id:"anti-call-llm-command",children:"anti-call-llm command"}),"\n",(0,s.jsx)(n.p,{children:"Anti-call the LLM interface"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"rock model-service anti-call-llm --index <index> [--response <response>]\n"})}),"\n",(0,s.jsx)(n.p,{children:"Parameters:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"--index"}),": Index of the previous LLM call, starting from 0"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"--response"}),": Response from the previous LLM call (optional)"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"file-communication-protocol",children:"File Communication Protocol"}),"\n",(0,s.jsx)(n.p,{children:"The model service uses files for inter-process communication, defining specific marker formats to distinguish requests and responses:"}),"\n",(0,s.jsx)(n.h3,{id:"request-format",children:"Request Format"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"LLM_REQUEST_START{JSON request data}LLM_REQUEST_END{metadata JSON}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"response-format",children:"Response Format"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"LLM_RESPONSE_START{JSON response data}LLM_RESPONSE_END{metadata JSON}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"session-end-marker",children:"Session End Marker"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"SESSION_END\n"})}),"\n",(0,s.jsx)(n.p,{children:"Metadata contains timestamp and index information to ensure message order and processing."}),"\n",(0,s.jsx)(n.h2,{id:"sdk-usage",children:"SDK Usage"}),"\n",(0,s.jsx)(n.h3,{id:"modelserviceconfig",children:"ModelServiceConfig"}),"\n",(0,s.jsxs)(n.p,{children:["Model service configuration class, located in ",(0,s.jsx)(n.code,{children:"rock/sdk/sandbox/model_service/base.py"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'from rock.sdk.sandbox.model_service.base import ModelServiceConfig\n\nconfig = ModelServiceConfig(\n    enabled=True,\n    type="local",                                      # Service type\n    install_cmd="pip install rock-model-service",      # Install command\n    install_timeout=300,                               # Install timeout (seconds)\n    start_cmd="rock model-service start --type ${type}",  # Start command\n    stop_cmd="rock model-service stop",                # Stop command\n    logging_path="/data/logs",                         # Log path\n    logging_file_name="model_service.log",             # Log filename\n)\n'})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Config"}),(0,s.jsx)(n.th,{children:"Default"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"enabled"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"False"})}),(0,s.jsx)(n.td,{children:"Whether to enable model service (RockAgent manages)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"type"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:'"local"'})}),(0,s.jsxs)(n.td,{children:["Service type: ",(0,s.jsx)(n.code,{children:"local"})," or ",(0,s.jsx)(n.code,{children:"proxy"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"install_cmd"})}),(0,s.jsx)(n.td,{children:"-"}),(0,s.jsx)(n.td,{children:"Model service package install command"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"install_timeout"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"300"})}),(0,s.jsx)(n.td,{children:"Install timeout in seconds"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"start_cmd"})}),(0,s.jsx)(n.td,{children:"-"}),(0,s.jsx)(n.td,{children:"Start command template"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"stop_cmd"})}),(0,s.jsx)(n.td,{children:"-"}),(0,s.jsx)(n.td,{children:"Stop command"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"logging_path"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"/data/logs"})}),(0,s.jsx)(n.td,{children:"Log directory path"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"logging_file_name"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"model_service.log"})}),(0,s.jsx)(n.td,{children:"Log filename"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"modelservice",children:"ModelService"}),"\n",(0,s.jsx)(n.p,{children:"Model service management class, handles the lifecycle of model services within the sandbox:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'from rock.sdk.sandbox.client import Sandbox\nfrom rock.sdk.sandbox.model_service.base import ModelServiceConfig, ModelService\n\nsandbox = Sandbox(config)\nmodel_service = ModelService(sandbox, ModelServiceConfig())\n\n# Typically auto-managed by RockAgent, no manual calls needed\n# The following methods are only for manual control when needed\n\n# Install model service\nawait model_service.install()\n\n# Start model service\nawait model_service.start()\n\n# Monitor agent process\nawait model_service.watch_agent(pid="12345")\n\n# Execute anti-call LLM (Core API for Local mode)\nresult = await model_service.anti_call_llm(\n    index=0,\n    response_payload=\'{"content": "response"}\',\n    call_timeout=600,\n    check_interval=3,\n)\n\n# Stop model service\nawait model_service.stop()\n'})}),"\n",(0,s.jsx)(n.h2,{id:"api-reference",children:"API Reference"}),"\n",(0,s.jsx)(n.h3,{id:"install",children:"install()"}),"\n",(0,s.jsx)(n.p,{children:"Install model service dependencies in the sandbox."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"await model_service.install()\n"})}),"\n",(0,s.jsx)(n.p,{children:"Execution steps:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Create and initialize Python runtime environment"}),"\n",(0,s.jsx)(n.li,{children:"Create Rock config file"}),"\n",(0,s.jsx)(n.li,{children:"Install model service package"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Note:"})," Typically auto-called by RockAgent."]}),"\n",(0,s.jsx)(n.h3,{id:"start",children:"start()"}),"\n",(0,s.jsx)(n.p,{children:"Start the model service."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"await model_service.start()\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Prerequisite: Must call ",(0,s.jsx)(n.code,{children:"install()"})," first."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Note:"})," Typically auto-called by RockAgent."]}),"\n",(0,s.jsx)(n.h3,{id:"stop",children:"stop()"}),"\n",(0,s.jsx)(n.p,{children:"Stop the model service."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"await model_service.stop()\n"})}),"\n",(0,s.jsx)(n.p,{children:"If the service is not running, this operation will be skipped."}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Note:"})," Typically auto-called by RockAgent."]}),"\n",(0,s.jsx)(n.h3,{id:"watch_agentpid",children:"watch_agent(pid)"}),"\n",(0,s.jsx)(n.p,{children:"Monitor the agent process."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'await model_service.watch_agent(pid="12345")\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Sends ",(0,s.jsx)(n.code,{children:"SESSION_END"})," message when the process exits."]}),"\n",(0,s.jsx)(n.h3,{id:"anti_call_llmindex-response_payload-call_timeout-check_interval",children:"anti_call_llm(index, response_payload, call_timeout, check_interval)"}),"\n",(0,s.jsxs)(n.p,{children:["Execute anti-call LLM operation. ",(0,s.jsx)(n.strong,{children:"This is the most important API in Local mode."})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'result = await model_service.anti_call_llm(\n    index=0,                                   # LLM call index\n    response_payload=\'{"result": "..."}\',       # Response data (optional)\n    call_timeout=600,                          # Operation timeout (seconds)\n    check_interval=3,                          # Status check interval (seconds)\n)\n'})}),"\n",(0,s.jsx)(n.h2,{id:"configuration-options",children:"Configuration Options"}),"\n",(0,s.jsx)(n.h3,{id:"service-configuration",children:"Service Configuration"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"SERVICE_HOST"}),": Service host address, defaults to ",(0,s.jsx)(n.code,{children:'"0.0.0.0"'})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"SERVICE_PORT"}),": Service port, defaults to ",(0,s.jsx)(n.code,{children:"8080"})]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"log-configuration",children:"Log Configuration"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"LOG_FILE"}),": Log file path used for communication, containing request and response data"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"polling-configuration",children:"Polling Configuration"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"POLLING_INTERVAL_SECONDS"}),": Polling interval, defaults to ",(0,s.jsx)(n.code,{children:"0.1"})," seconds"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"REQUEST_TIMEOUT"}),": Request timeout, defaults to unlimited"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"marker-configuration",children:"Marker Configuration"}),"\n",(0,s.jsx)(n.p,{children:"Defines markers used to distinguish different types of messages in the log file:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"REQUEST_START_MARKER"})," / ",(0,s.jsx)(n.code,{children:"REQUEST_END_MARKER"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"RESPONSE_START_MARKER"})," / ",(0,s.jsx)(n.code,{children:"RESPONSE_END_MARKER"})]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"SESSION_END_MARKER"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}},28453(e,n,l){l.d(n,{R:()=>c,x:()=>o});var i=l(96540);const s={},r=i.createContext(s);function c(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:c(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);